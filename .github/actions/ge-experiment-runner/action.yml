name: 'GE Experiment Runner'
description: 'Experiment Report'
inputs:
  task:
    description: ""
    required: true
  warmups:
    description: "Number of build warmups"
    required: false
    default: 1
  iterations:
    description: "Number of iterations"
    required: false
    default: 5
  class:
    description: ""
    required: true
  variant:
    description: ""
    required: true
  experiment-id:
    description: ""
    required: true
  api-key:
    description: ""
    required: true
runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-java@v3
      with:
        distribution: zulu
        java-version: 11.0.4
    - uses: sdkman/sdkman-action@master
      id: sdkman
      with:
        candidate: gradleprofiler
        version: 0.19.0
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
    - name: Execute Gradle build
      id : geapix
      run: |
           branch_exp=$(git rev-parse --abbrev-ref HEAD)
           echo $branch_exp
           if [ "${{inputs.variant}}" == "main" ]; then
              git fetch origin
              git checkout main
              git status
           fi
           unzip  ${{ steps.sdkman.outputs.file }}
           echo $'assemble { \n title= "assemble" \n tasks = [${{ inputs.task }}] \n cleanup-tasks = ["clean"] \n  apply-abi-change-to = [${{ inputs.class }}] \n gradle-args = ["-Dscan.tag.${{ inputs.variant }}", "-Dscan.tag.experiment", "-Dscan.tag.${{inputs.experiment-id}}"] \n}' >scenario
           gradle-profiler-0.19.0/bin/gradle-profiler --benchmark --scenario-file scenario assemble --warmups ${{ inputs.warmups }} --iterations ${{ inputs.iterations }}

           if [ "${{inputs.variant}}" == "main" ]; then
              git fetch origin
              git checkout testing_ge_reports_and_runners
              git status
           fi
           
           CA=""
           while read line
           do
              CA="$CA $line\n"
           done < <(tail -n +2 profiler-out/benchmark.csv)
           SUMMARY=$'# ${{inputs.variant}}\n## Results \n ${CA}'
           echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
           
      shell: bash
      env:
        GRADLE_ENTERPRISE_ACCESS_KEY: ${{ inputs.api-key }}
    - name: Archive production artifacts
      uses: actions/upload-artifact@v3
      with:
        name: profiler-${{inputs.variant}}
        path: |
          profile-out/*
                  
